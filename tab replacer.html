<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>4 tab replacer</title>
	<style>
		body
		{
			font-size: 80%;
		}
		textarea
		{
			width: 100%;
			height: 200px;
			ecolor: rgba(255, 255, 255, 0.1);
			background-color: transparent;
			font-family: courier;
			font-family: Andale Mono;
			font-family: Monaco;
			font-size: 7pt;
		}
		td
		{
			vertical-align: top;
			width: 50%;
		}
		#highlighted, .tabspaceviewer
		{
			white-space: pre;
			font-family: monaco;
		}
		#fontWidthMeasurer
		{
			white-space: pre;
			font-family: monaco;
		}
		
		.visualtab
		{
			background-color: red;
			position: absolute;
			display: inline-block;
			border-left: solid 1px #ddd;
			height: 700px;
		}
		
		.space:before
		{
			content: '·';
		}
		.tab:before
		{
			content: '→';
		}
		.tab2:before
		{
			content: '!';
		}
		.newline, .space, .tab, .tab2
		{
			color: rgb(83, 180, 255);
			position: absolute;
		}
		
		#highlighted2
		{
			border: solid 1px #ddd;
			font-family: courier;
			font-family: Andale Mono;
			white-space: pre;
			font-family: monaco;

			-webkit-user-modify: read-write;

		}
		
		.marginedTabContainer
		{
			background-color: rgba(200, 200, 255, 0.7);
			epadding-left: 20px;
			e-webkit-user-modify: read-only;
			epadding-right: 10px;
		}
		.marginedTabContainer span
		{
			e-webkit-user-modify: read-only;
		}
		.marginedTab:after
		{
			content: '!';
		}
		.marginedTab
		{
			background-color: rgba(255, 200, 200, 0.7);
			edisplay: inline-block;
			ewidth: 20px;
			eclip: rect(0px,1px,1px,0px);
			margin-right: 120px;
			evisibility: hidden;
			display: none;
/*
			emargin-left: -5px;
			margin-left: -1px;
			
			
			display: inline-block;
			position: relative;
			z-index: 4;
			border-left: solid 1px rgba(0, 255, 0, 0.5);
			border-right: solid 1px rgba(0, 255, 0, 0.5);
*/
		}
		.marginedTab2
		{
			padding-left: 8px;
		}
		
		.marginedTabContainer3
		{
			background-color: rgba(100, 255, 100, 0.7);
/*
			epadding-right: 12px;
			padding-right: 2.1ex;
			padding-right: 9pt;
			padding-right: 12px;
			edisplay: inline-table;
			edisplay: inline-block;
*/
/*
block, compact, inline, inline-block, inline-table, list-item, none, run-in, table, table-caption, table-cell, table-column, table-column-group, table-footer-group, table-header-group, table-row, table-row-group
*/
		}
		.marginedTabContainer3:after
		{
			econtent: '@';
			-webkit-user-modify: read-only;
		}
		
</style>
</head>
<body>
<table style='table-layout: fixed; width: 100%'><tr><td style='width: 480px'>
	<textarea>
Voici un tab
123456781234567812345
1	2	3	4	5	6	7	8
12	34	56	78	12
123	456	781	234	567
123	4	56	781234	5
1234	5678	1234	5678	1
12345	67812	34567	81
123456	789123	456789
a	b.	c	.....	.
...	.	.	...	..	......	.



The following lines have the same length
12345678123456781
1	2	3	4	5

</textarea>
<td style='width: 40px'>
</td><td>
	<span id='fontWidthMeasurer'>1</span>
<div class='tabspaceviewer'><span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    </div>

	<div id='highlighted' contentEditable='true'></div>
highlighted2 :

	<div id='highlighted2' econtentEditable='true'>
Suiv.....	tab
1**	2	3*	4**	5***	6	7**	8
<div>1	2	3	4	5	6	7	8	9	0	1	2	3	4	5	6	7	8	a	b	c	d
</div><div>12	34	56	78	12
</div><div>123	456	781	234	567
</div>123	4	56	781234	5
1234	5678	1234	5678	1
12345	67812	34567	81
123456	789123	456789
</div>
highlighted2 dump :
	<textarea id='highlighted2dump'></textarea>
highlighted2 measure :
	<div id='highlighted3' econtentEditable='true'><span>1</span> (used for measure)</div>
</td></tr></table>
	<pre id='dump'></pre>
	<pre id='dump2'></pre>
	<hr>
		<script>
			function	getTickCount()
			{
				return (new Date).getTime()
			}
			function	dumpHash(o)
			{
				var str = ''
				for (var i in o) str += i + '=' + o[i] + '\n'
				return str
			}

			//
			// Parse
			// 
			var textarea = document.getElementsByTagName('TEXTAREA')[0]
			function update()
			{
				var source = textarea.value
				
				var lines = source.split('\n')
				var str = ''
				
				var sizes = {}
				
				var tabLength = 4
				function	replaceTabs(a, b, c)
				{
//					alert(a + '*' + b + '*' + c + '*')
//					rez()
					
					str2 += ' pos=' + b
					str2 += ' delta=' + deltaTabPosition
					str2 += ' posWithDelta=' + (b+deltaTabPosition)
					var pos = (b+deltaTabPosition) % tabLength
					
					pos = tabLength - pos

					str2 += ' pos=' + pos
					
					if (!sizes[pos]) sizes[pos] = 0
					sizes[pos]++
					
/*
					str2 += ' posWdelta=' + pos
					pos = 4-pos
					str2 += ' adjdelta=' + pos
*/
					str2 += '<br>'

					// Add spaces to position (minus one to 'remove' the tab)
					deltaTabPosition += pos-1
					
					var str = ''
					for (var i=0; i<pos; i++) str += ' '
					str = '<span class="tab"></span>' + str + '<span class="tab2"></span>'
					return str
					return '\t'
				}
				
				var deltaTabPosition
				var str2 = getTickCount() + '<br>'
				for (var i=0; i<lines.length; i++)
//var i = 2
				{
					var line = lines[i]
					
					deltaTabPosition = 0
//					space = space.replace(/ /g, '<span class="space"></span> ')
					line = line.replace(/ /g, '_')
					line = line.replace(/\t/g, replaceTabs)
					line = line.replace(/_/g, '<span class="space"></span> ')
					
					str += line + '\n'
				}
				document.getElementById('highlighted').innerHTML = str
				
				str2 = dumpHash(sizes) + str2
				document.getElementById('dump').innerHTML = str2
			}

			update()
			
			
			function	update2()
			{
				var r = '<span class="marginedTabContainer">' + String.fromCharCode(0x200b) + ' ' + '<span class="marginedTab">	</span></span>'
				r = '<span class="marginedTabContainer3" estyle="padding-right: 10px"> </span>'
				
				var sel = getSelection()
				sel.modify('extend', 'left', 'documentboundary')
//				alert('k')
				var l = sel.toString().length
//				alert(l)

				var tabLength = 4
				function	replaceTabs(a, b, c)
				{
					var pos = (b+deltaTabPosition) % tabLength
					pos = tabLength - pos

					// Add spaces to position (minus one to 'remove' the tab)
					deltaTabPosition += pos-1

					return '<span class="marginedTabContainer3" style="padding-right:' + (pos-1)*fontWidth +  'px"> ' + '</span>'
				}
				
				var n = document.getElementById('highlighted2')
				var ns = document.getElementsByClassName('marginedTabContainer3')
//				alert(ns.length)
				for (var i=0; i<ns.length; i++) ns[i].innerHTML = '\t'
				var t = n.innerText
				var lines = t.split('\n')
//				var t = t.replace(/\t/g, r)
				var lines2 = []
				for (var i=0; i<lines.length; i++)
				{
					var line = lines[i]
					var deltaTabPosition = 0
					line = line.replace(/\t/g, replaceTabs)
					lines2.push(line)
				}
				n.innerHTML = lines2.join('\n')
				
				
				sel.selectAllChildren(n)
				sel.collapseToStart()
				for (var i=0; i<l; i++)
					sel.modify('move', 'right', 'character')
				
				var n = document.getElementById('highlighted2dump')
				n.value = t
//				alert('l')
			}
			function	update3()
			{
				document.getElementById('highlighted2dump').value = document.getElementById('highlighted2').innerHTML
			}
			
			var fontWidth = document.getElementById('fontWidthMeasurer').offsetWidth
			
			var highlighted = document.getElementById('highlighted')
			var highlighted2 = document.getElementById('highlighted2')
			var highlighted3 = document.getElementById('highlighted3')
			
			
//			document.body.onkeyup = update
			textarea.onkeyup = update

			document.getElementById('highlighted2').onkeyup = update2
//			document.getElementById('highlighted2').onkeyup = update3
			update2()
			update3()

			//
			// Focus textarea
			// 
			function	focusMe()
			{
				var textarea = document.getElementsByTagName('TEXTAREA')[0]
				textarea.focus()
			}
			setTimeout(focusMe, 10)
		</script>

<pre>

</body>
</html>
