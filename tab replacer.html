<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>4 tab replacer</title>
	<style>
		body
		{
			font-size: 80%;
		}
		.textarea
		{
			width: 100%;
			height: 200px;
			ecolor: rgba(255, 255, 255, 0.1);
			background-color: transparent;
			font-family: courier;
			font-family: Andale Mono;
			font-family: Monaco;
			font-size: 7pt;
		}
		td
		{
			vertical-align: top;
			width: 50%;
		}
		#highlighted, .tabspaceviewer
		{
			white-space: pre;
			font-family: monaco;
		}
		#fontWidthMeasurer
		{
			white-space: pre;
			font-family: monaco;
		}
		
		.visualtab
		{
			ebackground-color: red;
			position: absolute;
			display: inline-block;
			border-left: solid 1px rgba(0, 0, 0, 0.2);
			height: 700px;
			edisplay: none;
		}
		
		.space:before
		{
			content: '·';
		}
		.tab:before
		{
			content: '→';
		}
		.tab2:before
		{
			content: '!';
		}
		.newline, .space, .tab, .tab2
		{
			color: rgb(83, 180, 255);
			position: absolute;
		}
		
		#highlighted2
		{
			border: solid 1px #ddd;
			font-family: courier;
			font-family: Andale Mono;
			white-space: pre;
			font-family: monaco;

			-webkit-user-modify: read-write;

		}
		
		.marginedTabContainer
		{
			background-color: rgba(200, 200, 255, 0.7);
			epadding-left: 20px;
			e-webkit-user-modify: read-only;
			epadding-right: 10px;
		}
		.marginedTabContainer span
		{
			e-webkit-user-modify: read-only;
		}
		.marginedTab:after
		{
			content: '!';
		}
		.marginedTab
		{
			background-color: rgba(255, 200, 200, 0.7);
			edisplay: inline-block;
			ewidth: 20px;
			eclip: rect(0px,1px,1px,0px);
			margin-right: 120px;
			evisibility: hidden;
			display: none;
/*
			emargin-left: -5px;
			margin-left: -1px;
			
			
			display: inline-block;
			position: relative;
			z-index: 4;
			border-left: solid 1px rgba(0, 255, 0, 0.5);
			border-right: solid 1px rgba(0, 255, 0, 0.5);
*/
		}
		.marginedTab2
		{
			padding-left: 8px;
		}
		
		.marginedTabContainer3
		{
			background-color: rgba(100, 255, 100, 0.7);
/*
			epadding-right: 12px;
			padding-right: 2.1ex;
			padding-right: 9pt;
			padding-right: 12px;
			edisplay: inline-table;
			edisplay: inline-block;
*/
/*
block, compact, inline, inline-block, inline-table, list-item, none, run-in, table, table-caption, table-cell, table-column, table-column-group, table-footer-group, table-header-group, table-row, table-row-group
*/
		}
		.marginedTabContainer3:after
		{
			econtent: '@';
			-webkit-user-modify: read-only;
		}
		
		.fakeImageTab
		{
			height: 20px; 
			background-color: rgba(255, 200, 255, 0.5);
			content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAAmJLR0QAAKqNIzIAAAATSURBVHjaYzzAgB8wMYwqGEEKAK5fAOCh+eV3AAAAAElFTkSuQmCC);
		}
		.fakeImageTabContainer
		{
			opacity: 0.8;
		}
		
		#highlighted5
		{
			font-family: Monaco;
			font-size: 7pt;
			white-space: pre;
			-webkit-user-modify: read-write;
			border: solid 1px #888;
		}
		
		.fakeTab5
		{
			background-color: rgba(0, 0, 0, 0.2); 
/*
			e-webkit-user-modify: read-only; 
			epadding-left: 24px; 
			edisplay: inline-block; 
			ewidth: 24px;
			
			edisplay: inline-block;
			eoverflow: hidden;
			width: 24px;
			emargin-right: -16px;
			width: 200px;
			epadding-right: 10px;
			eposition: relative;
			ez-index: 4;
*/
			emargin-right: -16px;
			edisplay: inline-block;
			width: 23px;
			overflow: hidden;
		}
		
</style>
</head>
<body>
<table style='table-layout: fixed; width: 100%'><tr><td style='width: 480px'>
	<textarea class='textarea'>
Voici un tab
123456781234567812345
1	2	3	4	5	6	7	8
12	34	56	78	12
123	456	781	234	567
123	4	56	781234	5
1234	5678	1234	5678	1
12345	67812	34567	81
123456	789123	456789
a	b.	c	.....	.
...	.	.	...	..	......	.



The following lines have the same length
12345678123456781
1	2	3	4	5

</textarea>
<hr>
<div id='highlighted5' contentEditable='true'>1<img src='' style='width: 24px'>2imgIMG<img src='' style='width: 24px'>3<img src='' style='width: 24px'>4
	hello world ! <span class='fakeTab5'>	<span>e</span></span> check.
1<span class='fakeTab5' style='background-color: red; emargin-right: -16px'>	</span><span style='display: inline-block; epadding-right: 24px; background-color: lime; margin-right: -14px'></span>2-<span class='fakeTab5'>	</span>3--<span class='fakeTab5'>	</span>4---<span class='fakeTab5'>	</span>5----<span class='fakeTab5'>	</span>6-----<span class='fakeTab5'>	</span>7------<span class='fakeTab5'>	</span>8<span class='fakeTab5'>	</span>1
1<span class='fakeTab5'>	</span>2-<span class='fakeTab5'>	</span>3--<span class='fakeTab5'>	</span>4---<span class='fakeTab5'>	</span>5----<span class='fakeTab5'>	</span>6-----<span class='fakeTab5'>	</span>7------<span class='fakeTab5'>	</span>8<span class='fakeTab5'>	</span>1

1<span eclass='fakeTab5' style='background-color: lime; margin-right: 24px'> </span>2-<span class='fakeTab5'>	</span>3--<span class='fakeTab5'>	</span>4---<span class='fakeTab5'>	</span>5----<span class='fakeTab5'>	</span>6-----<span class='fakeTab5'>	</span>7------<span class='fakeTab5'>	</span>8<span class='fakeTab5'>	</span>1

img follows ...
1<span eclass='fakeTab5' style='background-color: lime; emargin-right: 24px'><img src='' style='width: 36px'></span>2-<span class='fakeTab5'>	</span>3--<span class='fakeTab5'>	</span>4---<span class='fakeTab5'>	</span>5----<span class='fakeTab5'>	</span>6-----<span class='fakeTab5'>	</span>7------<span class='fakeTab5'>	</span>8<span class='fakeTab5'>	</span>1

position absolute follows ...
1<span eclass='fakeTab5' style='background-color: orange; emargin-right: 24px'> <span style='position: absolute'>*****</span></span>2-<span class='fakeTab5'>	</span>3--<span class='fakeTab5'>	</span>4---<span class='fakeTab5'>	</span>5----<span class='fakeTab5'>	</span>6-----<span class='fakeTab5'>	</span>7------<span class='fakeTab5'>	</span>8<span class='fakeTab5'>	</span>1


inline block follows ...
1<span eclass='fakeTab5' style='background-color: #aac; display: inline-block; padding-right: 20px; ewidth: 32px; emargin-right: 4px; overflow: hidden'> </span>2-<span class='fakeTab5'>	</span>3--<span class='fakeTab5'>	</span>4---<span class='fakeTab5'>	</span>5----<span class='fakeTab5'>	</span>6-----<span class='fakeTab5'>	</span>7------<span class='fakeTab5'>	</span>8<span class='fakeTab5'>	</span>1

inline-block will make selection jump up and down.<span style="color: red">CHECK WITH LINES ENCLOSED IN DIVS</span> cured w/ div ! bof. NON. un ligne de code spannan plusier lign visuel plant.

<div>inline block in DIV follows ...</div><div>1<span eclass='fakeTab5' style='background-color: #aac; display: inline-block; padding-right: 20px; ewidth: 32px; emargin-right: 4px; overflow: hidden'> </span>2-<span class='fakeTab5'>	</span>3--<span class='fakeTab5'>	</span>4---<span class='fakeTab5'>	</span>5----<span class='fakeTab5'>	</span>6-----<span class='fakeTab5'>	</span>7------<span class='fakeTab5'>	</span>8<span class='fakeTab5'>	</span>1</div><div>div line</div>


raw image follows ...
1<img src='' style='width: 24px'>1<img src='' style='width: 24px'>1<img src='' style='width: 24px'>2


Hello button <button>a</button> eza <field>eaz</field>

5------<span class='fakeTab5'>	</span>6----<span class='fakeTab5'>	</span>7----<span class='fakeTab5'>	</span>8
	this is a test.
<span class='fakeTab5'>	</span></div>
use scrollLeft to show cursor

	<pre id='dump'></pre>
<td style='width: 40px'>
</td><td>
	<span id='fontWidthMeasurer'>1</span>
<div class='tabspaceviewer'><span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    <span class='visualtab'></span>    </div>

	<div id='highlighted' contentEditable='true'></div>
highlighted2 :

	<div id='highlighted2' econtentEditable='true'>
Suiv.....	tab et...	tab ////
1**	2	3*	4**	5***	6	7**	8
<div>1	2	3	4	5	6	7	8	9	0	1	2	3	4	5	6	7	8	a	b	c	d
</div><div>12	34	56	78	12
</div><div>123	456	781	234	567
</div>123	4	56	781234	5
1234	5678	1234	5678	1
12345	67812	34567	81
123456	789123	456789
</div>
highlighted2 dump :
	<textarea id='highlighted2dump' class='textarea'></textarea>
highlighted2 measure :
	<div id='highlighted3' econtentEditable='true'><span>1</span> (used for measure)</div>


	<div id='highlighted4' contentEditable='true' style='white-space: pre; border: solid 1px #aaa; font-family: monaco'>
fakeImageTab		
HELLO <img src="blank.png" style="width: 24px;"> IMAGE
HELLO <img esrc="" class='fakeImageTab' style='width: 24px'> IMAGE
hop
1	2	3	4
1<span style="font-size: 50%">	</span>2	3	4
	</div>

</td></tr></table>
	<pre id='dump2'></pre>
	<hr>
		<script>
			function	getTickCount()
			{
				return (new Date).getTime()
			}
			function	dumpHash(o)
			{
				var str = ''
				for (var i in o) str += i + '=' + o[i] + '\n'
				return str
			}

			//
			// Parse
			// 
			var textarea = document.getElementsByTagName('TEXTAREA')[0]
			function update()
			{
				var source = textarea.value
				
				var lines = source.split('\n')
				var str = ''
				
				var sizes = {}
				
				var tabLength = 4
				function	replaceTabs(a, b, c)
				{
//					alert(a + '*' + b + '*' + c + '*')
//					rez()
					
					str2 += ' pos=' + b
					str2 += ' delta=' + deltaTabPosition
					str2 += ' posWithDelta=' + (b+deltaTabPosition)
					var pos = (b+deltaTabPosition) % tabLength
					
					pos = tabLength - pos

					str2 += ' pos=' + pos
					
					if (!sizes[pos]) sizes[pos] = 0
					sizes[pos]++
					
/*
					str2 += ' posWdelta=' + pos
					pos = 4-pos
					str2 += ' adjdelta=' + pos
*/
					str2 += '<br>'

					// Add spaces to position (minus one to 'remove' the tab)
					deltaTabPosition += pos-1
					
					var str = ''
					for (var i=0; i<pos; i++) str += ' '
					str = '<span class="tab"></span>' + str + '<span class="tab2"></span>'
					return str
					return '\t'
				}
				
				var deltaTabPosition
				var str2 = getTickCount() + '<br>'
				for (var i=0; i<lines.length; i++)
//var i = 2
				{
					var line = lines[i]
					
					deltaTabPosition = 0
//					space = space.replace(/ /g, '<span class="space"></span> ')
					line = line.replace(/ /g, '_')
					line = line.replace(/\t/g, replaceTabs)
					line = line.replace(/_/g, '<span class="space"></span> ')
					
					str += line + '\n'
				}
				document.getElementById('highlighted').innerHTML = str
				
				str2 = dumpHash(sizes) + str2
				document.getElementById('dump').innerHTML = str2
			}

			update()
			
			function	htmlEncode(str)
			{
//				return str
				if (!str)	return ''
				str = str.replace(/</g, '&lt;')
				str = str.replace(/</g, '&lt;')
				str = str.replace(/</g, '&lt;')
				return str
			}
			
			
			function	dumpSelection()
			{
				var sel = getSelection()
				
				var str = getTickCount()
				if (sel.anchorNode)
				{
//					str += '\nanchorNode=' + sel.anchorNode + (sel.anchorNode.nodeType == 1 ? htmlEncode(sel.anchorNode.outerHTML) : '')
					str += '\n<table border="1" style="border-collapse: collapse; border-color: #ccc"><tr><td>anchorNode=<td>' + sel.anchorNode.nodeValue + '</table>'
					if (sel.anchorNode.nodeValue == null) str += '\n<span style="color: blue">HTML=' + htmlEncode(sel.anchorNode.outerHTML).substr(0, 50) + '</span>'
//					str += '\nanchorNode=' + htmlEncode(sel.anchorNode.outerHTML)
					str += '\nanchorNode.parentNode=' + htmlEncode(sel.anchorNode.parentNode.outerHTML).substr(0, 50)
					str += '\nanchorOffset=' + sel.anchorOffset
				}
				document.getElementById('dump').innerHTML = str
			}
			
			function	update2()
			{
//				var r = '<span class="marginedTabContainer">' + String.fromCharCode(0x200b) + ' ' + '<span class="marginedTab">	</span></span>'
//				r = '<span class="marginedTabContainer3" estyle="padding-right: 10px"> </span>'

				dumpSelection()
//return
				var sel = getSelection()
				if (sel.anchorNode)	
				{
					var str = sel.anchorNode.nodeValue + '=' + sel.anchorOffset
					if (!sel.anchorNode.nodeValue) str += '\n***\nhtmlNode=' + sel.anchorNode.outerHTML
					
//					alert(str)
				}
//				alert(dumpHash(sel))
				if (sel.type == 'Range')	return
/*				
				var str = getTickCount()
				if (sel.anchorNode)
				{
					str += '\nanchorNode=' + sel.anchorNode
					str += '\nanchorNode=' + sel.anchorNode.nodeValue
					str += '\nanchorNode=' + htmlEncode(sel.anchorNode.outerHTML)
					str += '\nanchorNode.parentNode=' + htmlEncode(sel.anchorNode.parentNode.outerHTML)
					str += '\nanchorOffset=' + sel.anchorOffset
				}
				document.getElementById('dump').innerHTML = str
*/				
				var n = document.getElementById('highlighted2')
//				var ns = n.getElementsByClassName('fakeImageTabContainer')
				var ns = n.getElementsByClassName('fakeTab5')
//				alert(ns.length)
				
				var direction = 'afterEnd'
				if (sel.anchorNode && sel.anchorNode.nodeType == 1 && sel.anchorNode.className == 'fakeImageTabContainer')	direction = 'beforeStart'
				var direction = 'beforeBegin'
				
				for (var i=0; i<ns.length; i++) 
				{
//					alert('a')
//					ns[i].innerHTML = '\t'
//					alert(ns[i].outerHTML)
//					eaz()
//					var n2 = document.createElement('SPAN')
//					n2.innerHTML = '\t'
//					var img = ns[i].firstChild
//					ns[i].replaceChild(n2, img)
//					alert(ns[i].outerHTML)
//					eaz()
//					alert('b')
					var n2 = document.createElement('SPAN')
					n2.innerText = '\t'
					ns[i].insertAdjacentElement(direction, n2)
//					ns[i].replaceNode(n2)
				} 
//				alert(n.innerHTML)
//				alert(ns.length)
				
				sel.modify('extend', 'left', 'documentboundary')
//				alert('k')
				var l = sel.toString().length
//				alert(l + '\nsel.anchorNode=' + sel.anchorNode + '\nsel=' + sel)

				var tabLength = 4
				function	replaceTabs(a, b, c)
				{
					var pos = (b+deltaTabPosition) % tabLength
					var initialPos = pos
					pos = tabLength - pos

					// Add spaces to position (minus one to 'remove' the tab)
					deltaTabPosition += pos-1

					var w = (pos)*fontWidth
					var s = ''
//					for (var i=0; i<pos; i++) s += (i+2)
					for (var i=initialPos; i<tabLength; i++) s += (i+1)
//					return '<span class="fakeImageTabContainer"><textarea disabled="true" cols="' + pos + '" style="background-color: rgba(0, 255, 0, 0.3); border: 0; margin: 0; padding: 0; font-size: inherit; font-family: inherit; ewidth: 8px; overflow: hidden">' + s + '</textarea></span>'
//					return '<span class="fakeImageTabContainer"><input disabled="true" type="text" value="' + s + '" size="' + pos + '" style="background-color: rgba(0, 255, 0, 0.3); border: 0; margin: 0; padding: 0; font-size: inherit; font-family: inherit; margin-left: -1px; margin-right: -1px; "></span>'
//					return '*'

					return "<img class='fakeTab5' src='' style='eborder: solid 1px red; height: 2px; background-color: lime; width: " + w + "px'>"
//					return "<span class='fakeTab5' style='background-color: lime; emargin-right: 24px'><img src='' style='width: " + w + "px'></span>"

//					return '<span class="fakeImageTabContainer"><img class="fakeImageTab" style="width: ' + w + 'px; evisibility: hidden; eopacity: 0.1"></span>'

//					return '<span class="marginedTabContainer3" style="padding-left:' + (pos-1)*fontWidth +  'px"> ' + '</span>'
//					return '<span class="marginedTabContainer3" style="padding-left:' + (pos-0)*fontWidth +  'px">' + '</span>'
//					var w = (pos)*fontWidth
//					return '<span class="marginedTabContainer3" style="padding-right: ' + w +  'px">' + String.fromCharCode(0x200b) + '</span>'
				}
//				for (var i=0; i<ns.length; i++) ns[i].parentNode.removeChild(ns[i])
				
				
				var t = n.innerText
//				alert(t)
				var lines = t.split('\n')
//				var t = t.replace(/\t/g, r)
				var lines2 = []
				for (var i=0; i<lines.length; i++)
				{
					var line = lines[i]
					var deltaTabPosition = 0
					line = line.replace(/\t/g, replaceTabs)
					lines2.push(line)
				}
				n.innerHTML = lines2.join('\n')
//				alert('rep !')
				
				sel.selectAllChildren(n)
				sel.collapseToStart()
				for (var i=0; i<l; i++)
					sel.modify('move', 'right', 'character')
				
				var n = document.getElementById('highlighted2dump')
				n.value = t
//				alert('l')
			}
			function	update3()
			{
				document.getElementById('highlighted2dump').value = document.getElementById('highlighted2').innerHTML
			}
			
			var fontWidth = document.getElementById('fontWidthMeasurer').offsetWidth
			
			var highlighted = document.getElementById('highlighted')
			var highlighted2 = document.getElementById('highlighted2')
			var highlighted3 = document.getElementById('highlighted3')

			var highlighted5 = document.getElementById('highlighted5')
			
			function	update5()
			{
				dumpSelection()
				
				var sel = getSelection()
				var p = sel.anchorNode.parentNode
				var str = '\n'
				if (p.nodeType == 1 && p.className == 'fakeTab5')
				{
					str += 'FAKETAB'
//					p.scrollLeft = 5000000
					
					var newSelection = sel.anchorNode.parentNode.nextSibling
//					alert(sel.anchorNode.parentNode.nextSibling)
//					alert(sel.anchorNode.parentNode.nextSibling.nodeValue)
//					alert('k')
//					sel.setPosition(highlighted5, 0)
//					alert('k')
//					sel.setPosition(newSelection, 0)
//					p.paddingRight = 10
				}
				document.getElementById('dump').innerHTML += str
			}
//				alert('make button to select post tab')
			highlighted5.onkeyup = update5
			
//			document.body.onkeyup = update
			textarea.onkeyup = update

			function	keydown2()
			{
				setTimeout(update2, 0)
			}
			document.getElementById('highlighted2').onkeydown = keydown2
//			document.getElementById('highlighted2').onkeyup = update2
			document.getElementById('highlighted2').onmouseup = dumpSelection
//			document.getElementById('highlighted2').onkeyup = update3
			update2()
			update3()

			//
			// Focus textarea
			// 
			function	focusMe()
			{
				var textarea = document.getElementsByTagName('TEXTAREA')[0]
				textarea.focus()
			}
			setTimeout(focusMe, 10)
		</script>

<pre>

</body>
</html>
